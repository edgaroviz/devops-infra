name: Destroy all Infra 

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  Terraform-init-validate-plan-apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::920373021859:role/ze_my_admin_role
          aws-region: eu-west-1
          role-session-name: APIActions
          role-duration-seconds: 3600

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.5

      - name: Terraform Destroy for all environments and regions (User Confirmation Required)
        run: |
          echo "⚠️ WARNING: You are about to DESTROY all Terraform resources."
          for env in tf-infra/env/*; do
            echo "Destroying Terraform resources in $env"
            for region in "$env"/*; do
              terraform -chdir=$region/infra init
              terraform -chdir=$region/infra destroy -auto-approve
              echo "Destroyed Terraform resources at $region"
            done
            echo "Completed destroy for $env"
          done
          else
            echo "❌ Terraform destroy cancelled."
            exit 1
          fi

      # - name: Create AWS ECR
      #   run: |
      #     echo $(pwd)
      #     cd tf-infra/resources/ecr
      #     terraform destroy -auto-approve

      # - name: Destroy S3 Bucket
      #   run: |
      #     echo $(pwd)
      #     cd tf-infra/resources/s3-bucket
      #     terraform destroy -auto-approve